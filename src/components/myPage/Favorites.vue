<script setup>
import { useFavoriteStore } from '@/stores/favoriteStore';
import { ref, onMounted, computed, onActivated } from 'vue';
import { getStoreList } from '@/services/storeService';
import { getFavorite } from '@/services/favoriteService';
import { useRouter, useRoute } from 'vue-router';

const router = useRouter();
const route = useRoute();

const favoriteStore = useFavoriteStore();

const isFavorite = (storeId) => {
  return favoriteStore.state.storeIds.includes(storeId);
};

const allStores = ref([]);

const fetchFavorites = async () => {
  const storeListRes = await getStoreList();
  if (storeListRes?.data?.resultData) {
    allStores.value = storeListRes.data.resultData;

    // 여기서 모든 store에 대해 찜 상태 확인
    for (const store of allStores.value) {
  const storeId = store.id || store.storeId; // 둘 중 하나라도 있으면 사용
  if (!storeId) continue; // 없으면 스킵

  const res = await getFavorite(storeId);
  if (res?.data?.resultData !== null) {
    favoriteStore.toggleFavorite(storeId);
  }
}
  }
};


onMounted(fetchFavorites);
onActivated(fetchFavorites);

const favoriteStores = computed(() => {
  console.log('찜한 storeIds:', favoriteStore.state.storeIds);
  console.log('전체 매장 목록:', allStores.value);

  return allStores.value.filter(store => 
    favoriteStore.state.storeIds.includes(store.id || store.storeId)
  );
});

const goToDetail = (storeId) => {
  if (!storeId) {
    console.warn("storeId가 없습니다.");
    return;
  }
  router.push(`/stores/${storeId}`);
};

const storeId = route.params.id;
console.log('라우터로 받은 storeId:', storeId);

</script>

<template>
  <div class="all-box">
    <div class="box">
      <div>
        <div>내가 찜한 가게</div>
        <div class="solid"></div>
      </div>

      <div class="store-list">
        <div
          class="store-card"
          v-for="store in favoriteStores"
          :key="store.id"
        >
          <img
            :src="`/imgs/${store.image}`"
            alt="가게 이미지"
            class="store-image"
          />
          <div class="store-info">
            <h3 class="store-title">{{ store.name }}</h3>
            <p class="store-sub">
              배달팁 {{ store.deliveryFee }}원 · 최소주문 {{ store.minOrderAmount }}원
            </p>
            <div class="store-meta">
              <span class="rating">⭐ {{ store.rating }}</span>
              <span class="likes" @click="toggleFavorite(store.id)">
                {{ isFavorite(store.id) ? '❤️' : '🤍' }} {{ store.likeCount || 0 }}
              </span>
            </div>
            <button class="detail-btn" @click="() => goToDetail(store.id ?? store.storeId)">자세히 보기</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>


<style lang="scss" scoped>
@font-face {
  font-family: "BMJUA";
  src: url("https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/BMJUA.woff")
    format("woff");
  font-weight: normal;
  font-style: normal;
}

.all-box {
  display: flex;
  justify-content: center;
}

.box {
  font-family: "BMJUA";
  font-size: 1.4em;
  letter-spacing: -1.5px;
  margin-top: 70px;
  margin-bottom: 120px;

  .solid {
    width: 1100px;
    border: 1px #000 solid;
    margin-top: 15px;
    margin-bottom: 30px;
  }
}

.store-list {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 32px;
  width: 1100px;
}

.store-card {
  display: flex;
  align-items: center;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 2px solid #666;
  overflow: hidden;
  padding: 20px 16px; // 세로 패딩 ↑
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.store-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.store-image {
  width: 110px;
  height: 110px;
  border-radius: 12px;
  object-fit: cover;
  margin-right: 14px;
}

.store-info {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  flex: 1;
}

.store-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 6px;
}

.store-sub {
  font-size: 13px;
  color: #666;
  margin-bottom: 12px;
}

.store-meta {
  display: flex;
  gap: 12px;
  font-size: 14px;
  margin-bottom: 12px;
}

.rating {
  color: #ffb400;
  font-weight: 500;
}

.likes {
  color: #ff6f61;
  font-weight: 500;
}

.detail-btn {
  background-color: #ff6f61;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 14px;
  cursor: pointer;
  font-weight: 500;
}
.detail-btn:hover {
  background-color: #e65c53;
}

</style>
